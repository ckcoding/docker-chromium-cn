map $http_authorization $_auth_header {
    default $http_authorization;
    ""      "Basic $cookie_auth";
}

server {
    listen 127.0.0.1:3099;
    location / {
        auth_basic "Login";
        auth_basic_user_file /etc/nginx/.htpasswd;
        root /usr/share/selkies/www;
        try_files /icon.png =404;
    }
}

server {
    listen 3000 default_server;
    listen [::]:3000 default_server;

    auth_request /_internal_auth;
    error_page 401 =200 /login.html;

    location = /_internal_auth {
        internal;
        proxy_pass http://127.0.0.1:3099/;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $_auth_header;
    }

    location = /login.html {
        auth_request off;
        root /usr/share/selkies/www/;
        add_header Cache-Control "no-store" always;
    }

    location = /icon.png {
        auth_request off;
        root /usr/share/selkies/www/;
    }

    location = /auth {
        auth_request off;
        proxy_pass http://127.0.0.1:3099/;
        proxy_set_header Authorization $http_authorization;
        proxy_intercept_errors on;
        error_page 401 = @auth_error;
    }

    location @auth_error {
        default_type text/plain;
        return 401 "Unauthorized";
    }

    location / {
        alias /usr/share/selkies/web/;
        index index.html index.htm;
        try_files $uri $uri/ =404;
    }

    location /devmode {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 10M;
        proxy_pass http://127.0.0.1:5173;
    }

    location /websocket {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 10M;
        proxy_pass http://127.0.0.1:8082;
    }

    location /files {
        fancyindex on;
        fancyindex_footer /nginx/footer.html;
        fancyindex_header /nginx/header.html;
        alias /config/Desktop/;
        if (-f $request_filename) {
            add_header Content-Disposition "attachment";
            add_header X-Content-Type-Options "nosniff";
        }
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/selkies/web/;
    }
}

server {
    listen 3001 ssl;
    listen [::]:3001 ssl;
    ssl_certificate /config/ssl/cert.pem;
    ssl_certificate_key /config/ssl/cert.key;

    auth_request /_internal_auth;
    error_page 401 =200 /login.html;

    location = /_internal_auth {
        internal;
        proxy_pass http://127.0.0.1:3099/;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $_auth_header;
    }

    location = /login.html {
        auth_request off;
        root /usr/share/selkies/www/;
        add_header Cache-Control "no-store" always;
    }

    location = /icon.png {
        auth_request off;
        root /usr/share/selkies/www/;
    }

    location = /auth {
        auth_request off;
        proxy_pass http://127.0.0.1:3099/;
        proxy_set_header Authorization $http_authorization;
        proxy_intercept_errors on;
        error_page 401 = @auth_error;
    }

    location @auth_error {
        default_type text/plain;
        return 401 "Unauthorized";
    }

    location / {
        alias /usr/share/selkies/web/;
        index index.html index.htm;
        try_files $uri $uri/ =404;
    }

    location /devmode {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 10M;
        proxy_pass http://127.0.0.1:5173;
    }

    location /websocket {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_buffering off;
        client_max_body_size 10M;
        proxy_pass http://127.0.0.1:8082;
    }

    location /files {
        fancyindex on;
        fancyindex_footer /nginx/footer.html;
        fancyindex_header /nginx/header.html;
        alias /config/Desktop/;
        if (-f $request_filename) {
            add_header Content-Disposition "attachment";
            add_header X-Content-Type-Options "nosniff";
        }
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/selkies/web/;
    }
}
