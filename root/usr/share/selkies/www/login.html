<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>授权登录</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #101a33;
        --card-border: #243150;
        --text: #e6ecff;
        --muted: #9fb0d3;
        --accent: #4cc9f0;
        --accent-strong: #2dd4bf;
        --error: #ff6b6b;
        --shadow: 0 20px 60px rgba(5, 10, 25, 0.55);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: grid;
        place-items: center;
        background:
          radial-gradient(1200px circle at 20% 10%, rgba(76, 201, 240, 0.15), transparent 60%),
          radial-gradient(900px circle at 80% 20%, rgba(45, 212, 191, 0.12), transparent 55%),
          radial-gradient(700px circle at 50% 90%, rgba(90, 103, 216, 0.18), transparent 60%),
          var(--bg);
        color: var(--text);
        font-family: "Noto Sans CJK SC", "Microsoft YaHei", "PingFang SC",
          "Hiragino Sans GB", "Segoe UI", sans-serif;
      }

      .card {
        width: min(420px, 92vw);
        padding: 32px 30px 28px;
        border-radius: var(--radius);
        background: linear-gradient(160deg, rgba(18, 30, 59, 0.98), rgba(12, 20, 40, 0.95));
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow);
        backdrop-filter: blur(6px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 18px;
      }

      .brand img {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #0f172a;
        padding: 6px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .brand h1 {
        font-size: 22px;
        margin: 0;
      }

      .brand p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .field {
        display: grid;
        gap: 8px;
        margin-bottom: 16px;
      }

      label {
        font-size: 13px;
        color: var(--muted);
      }

      input,
      select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid transparent;
        background: rgba(7, 12, 26, 0.9);
        color: var(--text);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      select:focus {
        border-color: rgba(76, 201, 240, 0.6);
        box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.15);
      }

      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin: 6px 0 18px;
        font-size: 12px;
        color: var(--muted);
      }

      .row label {
        display: flex;
        gap: 8px;
        align-items: center;
        cursor: pointer;
      }

      .row input[type="checkbox"] {
        width: 14px;
        height: 14px;
      }

      button {
        width: 100%;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        color: #0b1120;
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(76, 201, 240, 0.25);
      }

      .status {
        margin-top: 14px;
        min-height: 18px;
        font-size: 12px;
        color: var(--muted);
      }

      .status.error {
        color: var(--error);
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="brand">
        <img src="/icon.png" alt="Chromium" />
        <div>
          <h1>授权登录</h1>
          <p>请输入访问密码</p>
        </div>
      </div>

      <form id="login-form">
        <div class="field">
          <label for="password">密码</label>
          <input
            id="password"
            name="password"
            type="password"
            autocomplete="current-password"
            autofocus
            required
          />
        </div>

        <div class="field">
          <label for="ui-language">界面语言</label>
          <select id="ui-language" name="ui-language">
            <option value="zh">中文（默认）</option>
            <option value="en">English</option>
          </select>
        </div>

        <div class="row">
          <label>
            <input id="remember" type="checkbox" />
            记住我（7 天）
          </label>
        </div>

        <button type="submit">进入</button>
        <div id="status" class="status"></div>
      </form>
    </div>

    <script>
      const form = document.getElementById("login-form");
      const statusEl = document.getElementById("status");
      const languageEl = document.getElementById("ui-language");
      const params = new URLSearchParams(window.location.search);
      const authEndpoint = params.get("auth") || "/auth";
      // Username is fixed - matches CUSTOM_USER in docker-compose.yml
      const username = params.get("user") || "user";

      const normalizeUiLang = (langCode) => {
        if (typeof langCode !== "string" || !langCode.trim()) {
          return "zh";
        }
        const normalized = langCode.split("-")[0].toLowerCase();
        return normalized === "en" ? "en" : "zh";
      };

      const getMessages = (langCode) => {
        if (langCode === "en") {
          return {
            inputPassword: "Please enter password.",
            verifying: "Verifying...",
            wrongPassword: "Invalid password.",
            verifyFailed: (code) => `Verification failed (${code}).`,
            connectFailed: "Cannot connect to server. Please try again.",
          };
        }
        return {
          inputPassword: "请输入密码。",
          verifying: "正在校验...",
          wrongPassword: "密码错误。",
          verifyFailed: (code) => `校验失败（${code}）。`,
          connectFailed: "无法连接到服务器，请稍后重试。",
        };
      };

      const initialLang = normalizeUiLang(
        params.get("lang") || localStorage.getItem("selkies_ui_lang") || "zh"
      );
      languageEl.value = initialLang;
      localStorage.setItem("selkies_ui_lang", initialLang);

      const setStatus = (message, isError = false) => {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", isError);
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const password = document.getElementById("password").value;
        const remember = document.getElementById("remember").checked;
        const selectedLang = normalizeUiLang(languageEl.value);
        const messages = getMessages(selectedLang);
        localStorage.setItem("selkies_ui_lang", selectedLang);

        if (!password) {
          setStatus(messages.inputPassword, true);
          return;
        }

        const token = btoa(`${username}:${password}`);
        setStatus(messages.verifying);

        try {
          const response = await fetch(authEndpoint, {
            method: "GET",
            headers: {
              Authorization: `Basic ${token}`,
            },
            credentials: "same-origin",
            cache: "no-store",
          });

          if (!response.ok) {
            if (response.status === 401) {
              setStatus(messages.wrongPassword, true);
            } else {
              setStatus(messages.verifyFailed(response.status), true);
            }
            return;
          }

          const maxAge = remember ? 60 * 60 * 24 * 7 : null;
          document.cookie = `auth=${token}; Path=/; SameSite=Lax${
            maxAge ? `; Max-Age=${maxAge}` : ""
          }`;
          localStorage.setItem("auth", token);
          const target = new URL("/", window.location.origin);
          target.searchParams.set("lang", selectedLang);
          window.location.replace(target.toString());
        } catch (error) {
          setStatus(messages.connectFailed, true);
        }
      });
    </script>
  </body>
</html>
